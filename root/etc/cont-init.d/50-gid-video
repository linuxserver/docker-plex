#!/usr/bin/with-contenv bash

# check for the existence of a video and/or tuner device
if [ -e /dev/dri ] || [ -e /dev/dvb ]; then
	if [ -e /dev/dri ]; then
		VIDEO_GID=$(stat -c '%g' "$(find /dev/dri -type c -print -quit)")
	else
		VIDEO_GID=$(stat -c '%g' "$(find /dev/dvb -type c -print -quit)")
	fi
	# just add abc to root if stuff in dri/dvb is root owned
	if [ "${VIDEO_GID}" == "0" ]; then
		usermod -a -G root abc
		exit 0
	elif [ -z "${VIDEO_GID}" ]; then
		exit 0
	fi
else
	exit 0
fi

# Check if this GID matches the current abc user
ABCGID=$(getent group abc | awk -F: '{print $3}')
if [ "${ABCGID}" == "${VIDEO_GID}" ]; then
	exit 0
fi

# Check if the GID is taken and swap to 65533
CURRENT=$(getent group ${VIDEO_GID} | awk -F: '{print $1}')
if [ -z "${CURRENT}" ] || [ "${CURRENT}" == 'video' ]; then
	groupmod -g ${VIDEO_GID} video
	usermod -a -G video abc
else
	groupmod -g 65533 ${CURRENT}
	groupmod -g ${VIDEO_GID} video
	usermod -a -G video abc
fi
